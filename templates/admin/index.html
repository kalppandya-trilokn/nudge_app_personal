{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Statistics</h1>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-end g-3">
                <!-- Filter Select -->
                <div class="col-12 col-md-4">
                    <label for="filter-select" class="form-label fw-semibold text-secondary">Filter By</label>
                    <select class="form-select shadow-sm rounded-pill px-3 py-2" id="filter-select">
                        <option value="all" {% if filter_option == 'all' %}selected{% endif %}>All</option>
                        <option value="daily" {% if filter_option == 'daily' %}selected{% endif %}>Daily</option>
                        <option value="weekly" {% if filter_option == 'weekly' %}selected{% endif %}>Weekly</option>
                        <option value="monthly" {% if filter_option == 'monthly' %}selected{% endif %}>Monthly</option>
                        <option value="yearly" {% if filter_option == 'yearly' %}selected{% endif %}>Yearly</option>
                        <option value="to_date" {% if filter_option == 'to_date' %}selected{% endif %}>To Date</option>
                        <option value="custom_range" {% if filter_option == 'custom_range' %}selected{% endif %}>Custom Date Range</option>
                    </select>
                </div>

                <!-- Single Date Picker -->
                <div class="col-12 col-md-4" id="single-date-picker" style="display: none;">
                    <label class="form-label fw-semibold text-secondary">Select Date</label>
                    <div class="d-flex flex-wrap align-items-end gap-2">
                        <div class="flex-grow-1">
                            <input type="date" class="form-control form-control-sm border-0 shadow-sm rounded-pill px-3" id="single-date" value="{{ end_date_str|default:'' }}">
                        </div>
                        <button class="btn btn-primary shadow-sm rounded-pill px-4 flex-shrink-0" id="single-date-button">Apply</button>
                    </div>
                </div>

                <!-- Date Range Pickers -->
                <div class="col-12 col-md-8" id="date-pickers" style="display: none;">
                    <label class="form-label fw-semibold text-secondary">Select Range</label>
                    <div class="row g-3 d-flex flex-wrap align-items-end">
                        <div class="col-12 col-sm-6 col-md-5">
                            <div class="input-group shadow-sm rounded-pill overflow-hidden">
                                <input type="date" class="form-control form-control-sm border-0 px-3 flex-grow-1" id="start-date" value="{{ start_date_str|default:'' }}">
                            </div>
                        </div>
                        <div class="col-12 col-sm-6 col-md-5">
                            <div class="input-group shadow-sm rounded-pill overflow-hidden">
                                <input type="date" class="form-control form-control-sm border-0 px-3 flex-grow-1" id="end-date" value="{{ end_date_str|default:'' }}">
                            </div>
                        </div>
                        <div class="col-12 col-md-auto mt-2 mt-md-0 d-flex">
                            <button class="btn btn-primary shadow-sm rounded-pill px-4 flex-shrink-0" id="filter-button">Apply</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row">
        <div class="col-12 col-md-6 col-lg-6 mb-4">
            <div class="card {% if filter_option == 'all' %}shadow-sm{% else %}bg-gradient-info text-white shadow-sm{% endif %} h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <h2 class="display-4 fw-bold mb-0">
                        {% if filter_option == 'all' %}
                            {{ total_users|default:0 }}
                        {% else %}
                            {{ users_count|default:0 }}
                        {% endif %}
                    </h2>
                    <p class="text-uppercase fw-semibold mb-0">
                        {% if filter_option == 'all' %} All Users
                        {% elif filter_option == 'daily' %} Daily Users
                        {% elif filter_option == 'weekly' %} Weekly Users
                        {% elif filter_option == 'monthly' %} Monthly Users
                        {% elif filter_option == 'yearly' %} Yearly Users
                        {% elif filter_option == 'to_date' %} Users To Date
                        {% elif filter_option == 'custom_range' %} Custom Range Users
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom CSS tweak for tiny screens -->
<style>
@media (max-width: 576px) {
    .input-group > .form-control {
        font-size: 0.85rem;
    }
    .btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterSelect = document.getElementById('filter-select');
    const datePickers = document.getElementById('date-pickers');
    const singleDatePicker = document.getElementById('single-date-picker');
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const singleDateInput = document.getElementById('single-date');
    const filterButton = document.getElementById('filter-button');
    const singleDateButton = document.getElementById('single-date-button');

    function updateUI() {
        const selectedValue = filterSelect.value;
        datePickers.style.display = 'none';
        singleDatePicker.style.display = 'none';
        
        if (selectedValue === 'custom_range') {
            datePickers.style.display = 'block';
        } else if (selectedValue === 'to_date') {
            singleDatePicker.style.display = 'block';
        }
    }

    startDateInput.addEventListener('change', function() {
        if (startDateInput.value) {
            endDateInput.min = startDateInput.value;
        }
    });

    endDateInput.addEventListener('change', function() {
        if (endDateInput.value) {
            startDateInput.max = endDateInput.value;
        }
    });

    filterSelect.addEventListener('change', function() {
        const selectedValue = this.value;
        if (selectedValue === 'custom_range' || selectedValue === 'to_date') {
            updateUI();
        } else {
            window.location.href = `?filter=${selectedValue}`;
        }
    });

    filterButton.addEventListener('click', function() {
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        if (startDate && endDate) {
            window.location.href = `?filter=custom_range&start_date=${startDate}&end_date=${endDate}`;
        }
    });

    singleDateButton.addEventListener('click', function() {
        const singleDate = singleDateInput.value;
        if (singleDate) {
            window.location.href = `?filter=to_date&end_date=${singleDate}`;
        }
    });

    updateUI();
});
</script>

{% endblock %}
